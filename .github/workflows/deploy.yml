name: Deploy to Production

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    env:
      REGION: us-central1
      AUTONOMAX_SERVICE: autonomax-api
      AUTONOMAX_FRONTEND_SERVICE: autonomax-frontend
      YOUTUBE_FRONTEND_SERVICE: youtube-ai-frontend
      BACKEND_IMAGE: gcr.io/${{ secrets.GCP_PROJECT_ID }}/autonomax-api
      AUTONOMAX_FRONTEND_IMAGE: gcr.io/${{ secrets.GCP_PROJECT_ID }}/autonomax-frontend
      YOUTUBE_FRONTEND_IMAGE: gcr.io/${{ secrets.GCP_PROJECT_ID }}/youtube-ai-frontend
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Authenticate to Google Cloud
      uses: google-github-actions/auth@v2
      with:
        credentials_json: ${{ secrets.GCP_SA_KEY }}
    
    - name: Set up Google Cloud SDK
      uses: google-github-actions/setup-gcloud@v2

    - name: Validate Vertex AI and TTS roles
      env:
        GCP_SA_KEY: ${{ secrets.GCP_SA_KEY }}
        GCP_PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
      run: |
        python - <<'PY'
import json
import os
import subprocess

sa_json = json.loads(os.environ["GCP_SA_KEY"])
service_account = sa_json.get("client_email")
if not service_account:
    raise SystemExit("Missing client_email in GCP_SA_KEY")

project_id = os.environ.get("GCP_PROJECT_ID")
if not project_id:
    raise SystemExit("Missing GCP_PROJECT_ID")

policy = subprocess.check_output(
    ["gcloud", "projects", "get-iam-policy", project_id, "--format=json"]
)
data = json.loads(policy.decode("utf-8"))

required_roles = {"roles/aiplatform.user", "roles/texttospeech.user"}
found = set()
for binding in data.get("bindings", []):
    if binding.get("role") not in required_roles:
        continue
    if f"serviceAccount:{service_account}" in binding.get("members", []):
        found.add(binding["role"])

missing = required_roles - found
if missing:
    print(f"Missing required roles for {service_account}: {', '.join(sorted(missing))}")
    raise SystemExit(1)
print(f"Required roles present for {service_account}: {', '.join(sorted(found))}")
PY

    - name: Validate required secrets
      env:
        GCP_SA_KEY: ${{ secrets.GCP_SA_KEY }}
        GCP_PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
        DATABASE_URL: ${{ secrets.DATABASE_URL }}
        OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        SECRET_KEY: ${{ secrets.SECRET_KEY }}
        PAYMENT_SHOPIER_API_KEY: ${{ secrets.PAYMENT_SHOPIER_API_KEY }}
        PAYMENT_SHOPIER_API_SECRET: ${{ secrets.PAYMENT_SHOPIER_API_SECRET }}
        PAYMENT_SHOPIER_WEBHOOK_TOKEN: ${{ secrets.PAYMENT_SHOPIER_WEBHOOK_TOKEN }}
      run: |
        missing=0
        for var in GCP_SA_KEY GCP_PROJECT_ID DATABASE_URL OPENAI_API_KEY SECRET_KEY PAYMENT_SHOPIER_API_KEY PAYMENT_SHOPIER_API_SECRET PAYMENT_SHOPIER_WEBHOOK_TOKEN; do
          if [ -z "${!var}" ]; then
            echo "Missing required secret: $var"
            missing=1
          fi
        done
        if [ "$missing" -eq 1 ]; then
          exit 1
        fi
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r backend/requirements.txt
    
    - name: Run tests
      run: |
        python -m pytest backend/tests -v
      env:
        DATABASE_URL: sqlite:///./test.db
        OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        YOUTUBE_API_KEY: ${{ secrets.YOUTUBE_API_KEY }}
        SECRET_KEY: ${{ secrets.SECRET_KEY }}

    - name: Start backend for smoke test
      run: |
        nohup python -m uvicorn services.autonomax_api.main:app --host 0.0.0.0 --port 8000 > /tmp/uvicorn_smoke.log 2>&1 &
        echo $! > /tmp/uvicorn_smoke.pid
        sleep 2
      env:
        ENVIRONMENT: ci
        EMAIL_ENABLED: "false"
        DATA_DIR: /tmp

    - name: Smoke test payment flow
      run: |
        BASE_URL=http://localhost:8000 python scripts/first_transfer_smoke.py
      env:
        EMAIL_ENABLED: "false"
        DATA_DIR: /tmp

    - name: Stop backend after smoke test
      if: always()
      run: |
        if [ -f /tmp/uvicorn_smoke.pid ]; then
          kill "$(cat /tmp/uvicorn_smoke.pid)"
        fi
    
    - name: Build backend image
      run: |
        gcloud auth configure-docker --quiet
        docker build -t "${BACKEND_IMAGE}" -f services/autonomax_api/Dockerfile .
        docker push "${BACKEND_IMAGE}"
    
    - name: Deploy backend to Cloud Run
      id: deploy_backend
      uses: google-github-actions/deploy-cloudrun@v1
      with:
        service: ${{ env.AUTONOMAX_SERVICE }}
        image: ${{ env.BACKEND_IMAGE }}
        region: ${{ env.REGION }}
        env_vars: |
          ENVIRONMENT=production
          APP_TARGET=autonomax
          DATABASE_URL=${{ secrets.DATABASE_URL }}
          OPENAI_API_KEY=${{ secrets.OPENAI_API_KEY }}
          YOUTUBE_API_KEY=${{ secrets.YOUTUBE_API_KEY }}
          GOOGLE_CLOUD_PROJECT=${{ secrets.GCP_PROJECT_ID }}
          GOOGLE_CLOUD_STORAGE_BUCKET=${{ secrets.GCS_BUCKET }}
          SECRET_KEY=${{ secrets.SECRET_KEY }}
          PAYMENT_STRIPE_SECRET_KEY=${{ secrets.PAYMENT_STRIPE_SECRET_KEY }}
          PAYMENT_STRIPE_PUBLISHABLE_KEY=${{ secrets.PAYMENT_STRIPE_PUBLISHABLE_KEY }}
          PAYMENT_PAYONEER_API_KEY=${{ secrets.PAYMENT_PAYONEER_API_KEY }}
          PAYMENT_PAYONEER_SECRET_KEY=${{ secrets.PAYMENT_PAYONEER_SECRET_KEY }}
          PAYMENT_PAYONEER_PROGRAM_ID=${{ secrets.PAYMENT_PAYONEER_PROGRAM_ID }}
          PAYMENT_SHOPIER_API_KEY=${{ secrets.PAYMENT_SHOPIER_API_KEY }}
          PAYMENT_SHOPIER_API_SECRET=${{ secrets.PAYMENT_SHOPIER_API_SECRET }}
          PAYMENT_SHOPIER_PERSONAL_ACCESS_TOKEN=${{ secrets.PAYMENT_SHOPIER_PERSONAL_ACCESS_TOKEN }}
          PAYMENT_SHOPIER_WEBHOOK_TOKEN=${{ secrets.PAYMENT_SHOPIER_WEBHOOK_TOKEN }}
          SHOPIER_APP_MODE=true
          DATA_DIR=/app/persistent
          REVENUE_REAL_ONLY=true

    - name: Build Autonomax UI image
      run: |
        gcloud auth configure-docker --quiet
        docker build -t "${AUTONOMAX_FRONTEND_IMAGE}" \
          --build-arg NEXT_PUBLIC_BACKEND_URL="${{ steps.deploy_backend.outputs.url }}" \
          -f frontend_v3/Dockerfile frontend_v3
        docker push "${AUTONOMAX_FRONTEND_IMAGE}"

    - name: Deploy Autonomax UI to Cloud Run
      id: deploy_autonomax_ui
      uses: google-github-actions/deploy-cloudrun@v1
      with:
        service: ${{ env.AUTONOMAX_FRONTEND_SERVICE }}
        image: ${{ env.AUTONOMAX_FRONTEND_IMAGE }}
        region: ${{ env.REGION }}

    - name: Resolve YouTube backend URL
      id: youtube_backend
      run: |
        if [ -n "${{ secrets.YOUTUBE_BACKEND_URL }}" ]; then
          echo "url=${{ secrets.YOUTUBE_BACKEND_URL }}" >> "$GITHUB_OUTPUT"
        else
          echo "url=${{ steps.deploy_backend.outputs.url }}" >> "$GITHUB_OUTPUT"
        fi

    - name: Build YouTube UI image
      run: |
        gcloud auth configure-docker --quiet
        docker build -t "${YOUTUBE_FRONTEND_IMAGE}" \
          --build-arg VITE_API_BASE_URL="${{ steps.youtube_backend.outputs.url }}" \
          -f frontend/Dockerfile frontend
        docker push "${YOUTUBE_FRONTEND_IMAGE}"

    - name: Deploy YouTube UI to Cloud Run
      id: deploy_youtube_ui
      uses: google-github-actions/deploy-cloudrun@v1
      with:
        service: ${{ env.YOUTUBE_FRONTEND_SERVICE }}
        image: ${{ env.YOUTUBE_FRONTEND_IMAGE }}
        region: ${{ env.REGION }}

    - name: Verify payment endpoint on Cloud Run
      run: |
        if [ -z "${{ steps.deploy_backend.outputs.url }}" ]; then
          echo "Cloud Run URL missing from deploy step."
          exit 1
        fi
        endpoint="${{ steps.deploy_backend.outputs.url }}/api/payment/shopier/pay?amount=1.00&currency=USD&order_id=SMOKE-ORDER-001&product_name=Smoke+Check"
        curl -sSf "$endpoint" > /dev/null
        echo "Payment endpoint verified: $endpoint"

    - name: Post-deploy health report
      run: |
        BASE_URL="${{ steps.deploy_backend.outputs.url }}" python scripts/post_deploy_health_report.py

    - name: Production smoke test
      run: |
        BASE_URL="${{ steps.deploy_backend.outputs.url }}" SMOKE_AMOUNT=1.00 SMOKE_EMAIL=smoke-test@autonomax.io python scripts/first_transfer_smoke.py

  deploy_youtube_backend:
    runs-on: ubuntu-latest
    needs: deploy
    env:
      REGION: us-central1
      YOUTUBE_SERVICE: youtube-ai-backend
      YOUTUBE_BACKEND_IMAGE: gcr.io/${{ secrets.GCP_PROJECT_ID }}/youtube-ai-backend

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Authenticate to Google Cloud
      uses: google-github-actions/auth@v2
      with:
        credentials_json: ${{ secrets.GCP_SA_KEY }}

    - name: Set up Google Cloud SDK
      uses: google-github-actions/setup-gcloud@v2

    - name: Validate Vertex AI and TTS roles (YouTube)
      env:
        GCP_SA_KEY: ${{ secrets.GCP_SA_KEY }}
        GCP_PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
      run: |
        python - <<'PY'
import json
import os
import subprocess

sa_json = json.loads(os.environ["GCP_SA_KEY"])
service_account = sa_json.get("client_email")
if not service_account:
    raise SystemExit("Missing client_email in GCP_SA_KEY")

project_id = os.environ.get("GCP_PROJECT_ID")
if not project_id:
    raise SystemExit("Missing GCP_PROJECT_ID")

policy = subprocess.check_output(
    ["gcloud", "projects", "get-iam-policy", project_id, "--format=json"]
)
data = json.loads(policy.decode("utf-8"))

required_roles = {"roles/aiplatform.user", "roles/texttospeech.user"}
found = set()
for binding in data.get("bindings", []):
    if binding.get("role") not in required_roles:
        continue
    if f"serviceAccount:{service_account}" in binding.get("members", []):
        found.add(binding["role"])

missing = required_roles - found
if missing:
    print(f"Missing required roles for {service_account}: {', '.join(sorted(missing))}")
    raise SystemExit(1)
print(f"Required roles present for {service_account}: {', '.join(sorted(found))}")
PY

    - name: Validate required secrets (YouTube)
      env:
        GCP_SA_KEY: ${{ secrets.GCP_SA_KEY }}
        GCP_PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
        DATABASE_URL: ${{ secrets.DATABASE_URL }}
        SECRET_KEY: ${{ secrets.SECRET_KEY }}
        OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        YOUTUBE_DATABASE_URL: ${{ secrets.YOUTUBE_DATABASE_URL }}
        YOUTUBE_SECRET_KEY: ${{ secrets.YOUTUBE_SECRET_KEY }}
        YOUTUBE_OPENAI_API_KEY: ${{ secrets.YOUTUBE_OPENAI_API_KEY }}
      run: |
        missing=0
        require_pair() {
          local base="$1"
          local alt="$2"
          if [ -z "${!base}" ] && [ -z "${!alt}" ]; then
            echo "Missing required secret: $base or $alt"
            missing=1
          fi
        }
        for var in GCP_SA_KEY GCP_PROJECT_ID; do
          if [ -z "${!var}" ]; then
            echo "Missing required secret: $var"
            missing=1
          fi
        done
        require_pair DATABASE_URL YOUTUBE_DATABASE_URL
        require_pair SECRET_KEY YOUTUBE_SECRET_KEY
        require_pair OPENAI_API_KEY YOUTUBE_OPENAI_API_KEY
        if [ "$missing" -eq 1 ]; then
          exit 1
        fi

    - name: Build YouTube backend image
      run: |
        gcloud auth configure-docker --quiet
        docker build -t "${YOUTUBE_BACKEND_IMAGE}" -f services/youtube_ai_api/Dockerfile .
        docker push "${YOUTUBE_BACKEND_IMAGE}"

    - name: Deploy YouTube backend to Cloud Run
      id: deploy_youtube_backend
      uses: google-github-actions/deploy-cloudrun@v1
      with:
        service: ${{ env.YOUTUBE_SERVICE }}
        image: ${{ env.YOUTUBE_BACKEND_IMAGE }}
        region: ${{ env.REGION }}
        env_vars: |
          ENVIRONMENT=production
          APP_TARGET=youtube
          DATABASE_URL=${{ secrets.YOUTUBE_DATABASE_URL || secrets.DATABASE_URL }}
          OPENAI_API_KEY=${{ secrets.YOUTUBE_OPENAI_API_KEY || secrets.OPENAI_API_KEY }}
          YOUTUBE_API_KEY=${{ secrets.YOUTUBE_API_KEY }}
          GOOGLE_CLOUD_PROJECT=${{ secrets.GCP_PROJECT_ID }}
          GOOGLE_CLOUD_STORAGE_BUCKET=${{ secrets.GCS_BUCKET }}
          SECRET_KEY=${{ secrets.YOUTUBE_SECRET_KEY || secrets.SECRET_KEY }}
          PAYMENT_STRIPE_SECRET_KEY=${{ secrets.YOUTUBE_PAYMENT_STRIPE_SECRET_KEY || secrets.PAYMENT_STRIPE_SECRET_KEY }}
          PAYMENT_STRIPE_PUBLISHABLE_KEY=${{ secrets.YOUTUBE_PAYMENT_STRIPE_PUBLISHABLE_KEY || secrets.PAYMENT_STRIPE_PUBLISHABLE_KEY }}
          PAYMENT_PAYONEER_API_KEY=${{ secrets.YOUTUBE_PAYMENT_PAYONEER_API_KEY || secrets.PAYMENT_PAYONEER_API_KEY }}
          PAYMENT_PAYONEER_SECRET_KEY=${{ secrets.YOUTUBE_PAYMENT_PAYONEER_SECRET_KEY || secrets.PAYMENT_PAYONEER_SECRET_KEY }}
          PAYMENT_PAYONEER_PROGRAM_ID=${{ secrets.YOUTUBE_PAYMENT_PAYONEER_PROGRAM_ID || secrets.PAYMENT_PAYONEER_PROGRAM_ID }}
          PAYMENT_SHOPIER_API_KEY=${{ secrets.YOUTUBE_PAYMENT_SHOPIER_API_KEY || secrets.PAYMENT_SHOPIER_API_KEY }}
          PAYMENT_SHOPIER_API_SECRET=${{ secrets.YOUTUBE_PAYMENT_SHOPIER_API_SECRET || secrets.PAYMENT_SHOPIER_API_SECRET }}
          PAYMENT_SHOPIER_PERSONAL_ACCESS_TOKEN=${{ secrets.YOUTUBE_PAYMENT_SHOPIER_PERSONAL_ACCESS_TOKEN || secrets.PAYMENT_SHOPIER_PERSONAL_ACCESS_TOKEN }}
          PAYMENT_SHOPIER_WEBHOOK_TOKEN=${{ secrets.YOUTUBE_PAYMENT_SHOPIER_WEBHOOK_TOKEN || secrets.PAYMENT_SHOPIER_WEBHOOK_TOKEN }}
          SHOPIER_APP_MODE=true
          DATA_DIR=/app/persistent
          REVENUE_REAL_ONLY=true

    - name: Post-deploy health report (YouTube)
      run: |
        python -m pip install --upgrade pip
        pip install requests
        BASE_URL="${{ steps.deploy_youtube_backend.outputs.url }}" python scripts/post_deploy_health_report.py
