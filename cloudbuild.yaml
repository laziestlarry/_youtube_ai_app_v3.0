# cloudbuild.yaml (legacy monolith build)
steps:
  # 0. Build Autonomax UI (Next.js) for optional backend embed
  - name: "node:20"
    entrypoint: "bash"
    args:
      - "-c"
      - |
        cd frontend_v3
        npm ci
        npm run build
        # Move build output to where backend expects it (backend/main.py checks frontend/dist)
        # This is optional when deploying the UI separately.
        # main.py line 284: frontend_build_path = Path("frontend/dist")
        # We need to move frontend_v3/dist to frontend/dist or update main.py.
        # Easiest is to move it to frontend/dist (create dir if needed).
        mkdir -p ../frontend
        # Next.js "output: export" generates an "out" folder.
        # Backend expects "frontend/dist".
        mkdir -p ../frontend
        rm -rf ../frontend/dist
        mv out ../frontend/dist

  # 1. Build Backend Container (includes optional frontend artifacts)
  - name: "gcr.io/cloud-builders/docker"
    args:
      [
        "build",
        "-t",
        "gcr.io/$PROJECT_ID/autonomax-api",
        "-f",
        "services/autonomax_api/Dockerfile",
        ".",
      ]

  - name: "gcr.io/cloud-builders/docker"
    args: ["push", "gcr.io/$PROJECT_ID/autonomax-api"]

  - name: "gcr.io/google.com/cloudsdktool/cloud-sdk"
    entrypoint: gcloud
    args:
      [
        "run",
        "deploy",
        "autonomax-api",
        "--image",
        "gcr.io/$PROJECT_ID/autonomax-api",
        "--platform",
        "managed",
        "--region",
        "us-central1",
        "--allow-unauthenticated",
        "--port",
        "8080",
        "--add-cloudsql-instances",
        "$PROJECT_ID:us-central1:youtube-ai-db",
        "--add-volume=name=persistent-storage,type=cloud-storage,bucket=${PROJECT_ID}-data",
        "--add-volume-mount=volume=persistent-storage,mount-path=/app/persistent",
        "--set-secrets",
        "DATABASE_URL=youtube-ai-database-url:latest,SECURITY_SECRET_KEY=youtube-ai-security-secret-key:latest,PAYMENT_SHOPIER_API_KEY=youtube-ai-shopier-api-key:latest,PAYMENT_SHOPIER_API_SECRET=youtube-ai-shopier-api-secret:latest,PAYMENT_SHOPIER_PERSONAL_ACCESS_TOKEN=youtube-ai-shopier-pat:latest,PAYMENT_SHOPIER_WEBHOOK_TOKEN=youtube-ai-shopier-webhook-token:latest,OPENAI_API_KEY=OPENAI_API_KEY:latest",
        "--env-vars-file",
        "config/cloudrun.autonomax.env.yaml",
      ]
# For sensitive values, use Google Secret Manager and reference them in Cloud Run env config.

images:
  - "gcr.io/$PROJECT_ID/autonomax-api"

substitutions:
  _OPENAI_API_KEY: ""
  _GOOGLE_TTS_API_KEY: ""
  _DALLE_API_KEY: ""
  _YOUTUBE_CLIENT_ID: ""
  _YOUTUBE_CLIENT_SECRET: ""
  _YOUTUBE_REFRESH_TOKEN: ""
  _GEMINI_API_KEY: ""
  _GROQ_API_KEY: ""
  _SERPER_API_KEY: ""
  _REPLICATE_API_KEY: ""
  _FIGMA_API_KEY: ""
  _MIDJOURNEY_API_KEY: ""
  _PRINTBELLE_API_KEY: ""
  _STRIPE_API_KEY: ""
  _SHOPIFY_API_KEY: ""
  _SHOPIFY_API_SECRET: ""
  _PAYONEER_CUSTOMER_ID: ""
  _DATABASE_URL_PROD: "sqlite:///./youtube_ai.db"
  _REDIS_URL_PROD: ""
  _APP_SECRET_KEY: "change_me_in_production"
  _PAYMENT_SHOPIER_API_KEY: ""
  _PAYMENT_SHOPIER_API_SECRET: ""
  _SHOPIER_PERSONAL_ACCESS_TOKEN: ""
  _SHOPIER_WEBHOOK_TOKEN: ""
  _GCS_DATA_BUCKET: "${PROJECT_ID}-data"

options:
  substitutionOption: "ALLOW_LOOSE"
